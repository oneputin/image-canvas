<!doctype html>
<html>
<head>
    <title>image-remote-resize</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes">
    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>

    <link rel="import" href="../../fire-base/fire-query.html">
    <link rel="import" href="../resize-image.html">

</head>

<body>

  <h3>Demo <span style="font-family: courier;">resize-image-batch</span></h3>

  <dom-module id="resize-image-all"> 
    
    <template>
      <style>
      </style>

      <h4>1. Query ALL album-entries from cloud-db and create placeholder for "available" images.</h4>
      
      <!-- A. Query all objects (img-meta-documents) from path [cplocal] -->
      <fire-query app="wolke7" path="cplocal" item="_all_" data="{{dbdata}}"></fire-query>
     
      <template id="repeat1" is="dom-repeat" items="[[clientitems]]">
        
        <!-- B. Try to RESIZE -->  
        <resize-image src="[[item.url]]" out="{{item.placeholder}}" height="10" quality="0.5" format="jpeg"></resize-image>
        
        <!-- C. BACK-SAVE item, if placeholder-property was created -->
        <template is="dom-if" if="{{item.placeholder}}"> 
          <!-- <div>[[item.fbkey]]</div>  --><!-- debug-log -->
          
          <fire-query
              app="wolke7" 
              path="cplocal"
              key="[[item.fbkey]]"
              setdata="[[item]]">
          </fire-query>      

        </template>

      </template>        

      <!-- D. ??? CHECK number of album-records with placeholder -->
      <template is="dom-if" if="{{clientitemsdone}}"> 
        
        <h4> 2. Query album-entries with placeholder calculated.</h4>

        <fire-query app="wolke7" path="cplocal" item="placeholder" data="{{okdata}}"></fire-query>

      </template>

    </template>
    
    <script>
      window.addEventListener('WebComponentsReady', function() {
        Polymer({

          is: 'resize-image-all',

          properties: {

            clientitems: {
              type: Object,
              computed: 'createArray(dbdata)'
            },

            clientitemsdone : 0,

            okitems: {
              type: Object,
              observer: 'checkResults'
            },

          },
          
          ready: function() {
            this.$.repeat1.addEventListener("dom-change", function(event){
               // console.log(event);
               // this.clientitemsdone = 1;
            });
          },

          // Processes results of "ALL"-Query 
          // Transform "keyed"object into array and integrate 'fbkey'
          createArray: function(data) { 
            if (!data) return;
            // obj -> array with prop 'fbkey' 
            if (!Array.isArray(data)) {
              data =  Object.keys(data).map(function(k){
                var doc = data[k];
                doc.fbkey = k;
                return doc
              });
            }  console.log("length=", data.length); 
            return data; 
          },

          // Process results of "hasPlaceholder"-Query
          checkResults: function(data) {
            console.log("checked", data);
          }
          
        });  
      });      
    </script>      
  </dom-module>

  <resize-image-all></resize-image-all>

</body>
</html>
